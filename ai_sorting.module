<?php

/**
 * @file
 * Primary module file for AI Sorting.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\views\ViewExecutable;
use Drupal\Core\Url;
use Drupal\Core\Database\Database;
use Drupal\views\Plugin\views\query\Sql;

/**
 * Implements hook_help().
 */
function ai_sorting_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.ai_sorting':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The AI Sorting module provides an intelligent sorting mechanism for Drupal Views using the UCB2 algorithm.') . '</p>';
      return $output;
  }
}

/**
 * Implements hook_views_pre_render().
 */
function ai_sorting_views_pre_render(ViewExecutable $view) {
  // Check if the view query is an instance of Sql.
  if (!($view->query instanceof Sql)) {
    return;
  }

  // Check if the query contains 'node_ucb1_score'.
  $query_string = $view->build_info['query']->__toString();
  if (strpos($query_string, 'node_ucb1_score') === FALSE) {
    return;
  }

  // Proceed with AI sorting logic.
  if (!empty($view->style_plugin) && $view->style_plugin->usesFields()) {
    $nids = [];
    foreach ($view->result as $row) {
      if (isset($row->nid)) {
        $nids[] = $row->nid;
      }
    }
    
    if (!empty($nids)) {
      $view->element['#attached']['library'][] = 'ai_sorting/ai_sorting';
      $view->element['#attached']['drupalSettings']['aiSorting']['views'][$view->id()] = [
        'nids' => $nids,
        'incrementTrialsUrl' => Url::fromRoute('ai_sorting.increment_trials')->toString(),
      ];
    }

    // Log the original query.
    \Drupal::logger('ai_sorting')->notice('Q: @query', ['@query' => $query_string]);

    // Execute the original query and log the results.
    try {
      $original_result = $view->build_info['query']->execute();
      $original_data = $original_result->fetchAll(\PDO::FETCH_ASSOC);
      $result_string = print_r($original_data, TRUE);
      \Drupal::logger('ai_sorting')->notice('O: @results', ['@results' => $result_string]);
    }
    catch (\Exception $e) {
      \Drupal::logger('ai_sorting')->error('Error executing Original Query: @error', ['@error' => $e->getMessage()]);
    }

    // Create a new query object based on the original query.
    $cloned_query = clone $view->build_info['query'];

    // Remove only the LIMIT from the cloned query.
    $cloned_query->range();
    
    // Remove the node_ucb1_score expression from the query.
    $expressions = &$cloned_query->getExpressions();
    unset($expressions['node_ucb1_score']);

    // Remove the ORDER BY clause that uses node_ucb1_score.
    $orderby = &$cloned_query->getOrderBy();
    foreach ($orderby as $key => $order) {
        if (strpos($key, 'node_ucb1_score') !== false) {
            unset($orderby[$key]);
        }
    }

    // Add SUM of ai_sorting_trials to the query.
    $cloned_query->addExpression('SUM(COALESCE(node_counter.ai_sorting_trials, 0))', 'total_ai_sorting_trials');

    // Remove all fields to ensure we're only getting the sum.
    $fields = &$cloned_query->getFields();
    $fields = [];

    // Log the modified cloned query.
    $modified_query_string = $cloned_query->__toString();
    \Drupal::logger('ai_sorting')->notice('Q: @query', ['@query' => $modified_query_string]);

    // Execute the cloned query and log the results.
    try {
      $cloned_result = $cloned_query->execute();
      $cloned_data = $cloned_result->fetchAll(\PDO::FETCH_ASSOC);
      $cloned_result_string = print_r($cloned_data, TRUE);
      \Drupal::logger('ai_sorting')->notice('O: @results', ['@results' => $cloned_result_string]);
    }
    catch (\Exception $e) {
      \Drupal::logger('ai_sorting')->error('Error executing Cloned Query: @error', ['@error' => $e->getMessage()]);
    }

    // Utilize the TotalTrialsService to manage total trials.
    /** @var \Drupal\ai_sorting\Service\TotalTrialsService $total_trials_service */
    $total_trials_service = \Drupal::service('ai_sorting.total_trials_service');
    $view_id = $view->id();
    $display_id = $view->current_display;
    $total_trials = $total_trials_service->incrementTotalTrials($view_id, $display_id);

    \Drupal::logger('ai_sorting')->notice('Total Trials for view @view_id and display @display_id: @total', [
      '@view_id' => $view_id,
      '@display_id' => $display_id,
      '@total' => $total_trials,
    ]);
  }
}

/**
 * Implements hook_page_attachments().
 */
function ai_sorting_page_attachments(array &$attachments) {
  $attachments['#attached']['drupalSettings']['aiSorting']['csrfToken'] = \Drupal::csrfToken()->get('ai_sorting_increment_trials');
}

/**
 * Implements hook_views_data_alter().
 */
function ai_sorting_views_data_alter(array &$data) {
  $data['node']['ai_sorting'] = [
    'title' => t('AI Sorting'),
    'help' => t('Sort content using AI-based algorithm.'),
    'sort' => [
      'id' => 'ai_sorting',
    ],
  ];
}